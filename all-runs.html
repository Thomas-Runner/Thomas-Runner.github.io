<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thomas Runs — All Runs</title>
<link rel="stylesheet" href="style.css">
<style>
body { background: #000; color: #fff; font-family: Arial, sans-serif; }
table { border-collapse: collapse; width: 100%; margin: 20px 0; }
th, td { border: 1px solid #444; padding: 8px 12px; text-align: center; }
th { background: #111; cursor: pointer; color: #d8b3ff; } /* light purple header text */
tr:nth-child(even) { background: rgba(100,50,255,0.03); } /* very transparent neon shading */
tr:hover { background: rgba(100, 50, 255, 0.1); }

.glow-gold { 
  background: gold; 
  color: #000; 
  font-weight: bold; 
  animation: neonGold 1.5s infinite alternate;
}
.glow-silver {
  background: silver;
  color: #000;
  font-weight: bold;
  animation: neonSilver 1.5s infinite alternate;
}
.glow-bronze {
  background: #cd7f32;
  color: #000;
  font-weight: bold;
  animation: neonBronze 1.5s infinite alternate;
}

@keyframes neonGold {
  from { box-shadow: 0 0 5px gold, 0 0 10px gold; }
  to { box-shadow: 0 0 15px gold, 0 0 25px gold; }
}
@keyframes neonSilver {
  from { box-shadow: 0 0 5px silver, 0 0 10px silver; }
  to { box-shadow: 0 0 15px silver, 0 0 25px silver; }
}
@keyframes neonBronze {
  from { box-shadow: 0 0 5px #cd7f32, 0 0 10px #cd7f32; }
  to { box-shadow: 0 0 15px #cd7f32, 0 0 25px #cd7f32; }
}

th.sorted-asc::after { content: " ▲"; }
th.sorted-desc::after { content: " ▼"; }
@media (max-width: 1024px) { body { font-size: 14px; } table { font-size: 12px; } }
</style>
</head>
<body>
<header class="nav">
  <div class="nav-inner">
    <div class="brand">Thomas<span> Runs</span></div>
    <nav class="links">
      <a href="index.html" class="nav-link">Home</a>
      <a href="calendar.html" class="nav-link">Calendar</a>
      <a href="all-runs.html" class="nav-link active">All Runs</a>
      <a href="race-results.html" class="nav-link">Race Results</a>
      <a href="backyard-data.html" class="nav-link">Backyard Data</a>
    </nav>
  </div>
</header>

<main class="container">
  <table id="runs-table">
    <thead>
      <tr id="table-headers"></tr>
    </thead>
    <tbody id="table-body"></tbody>
  </table>
</main>

<script>
const sheetID = "13o2LBSWWdkp7d8UgmLG2kxq8m3cPTQSS1W3cry5JyV8";
const sheetTab = "run times";

// Columns to display, without 'AVG' and '1km (s)'
const columnsToShow = ["Date","1km","1mile","5km","10km","10mile","21.1km","30km","42.2km","50km","Distance","AVG Pace","Order","SS","ES","RS","CTL","ATL","TSB","Rank"];
const timeCols = ["1km","1mile","5km","10km","10mile","21.1km","30km","42.2km","50km"];
const highlightDistanceCol = "Distance";

// Fetch CSV
async function fetchSheetCSV() {
  const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetTab)}`;
  const res = await fetch(url);
  return await res.text();
}

// Parse CSV robustly
function parseCSV(csvText){
  const lines = csvText.split(/\r?\n/).filter(l=>l.trim()!=="");
  const rows = [];
  const headers = lines[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(h=>h.replace(/^"|"$/g,'').trim());
  for(let i=1;i<lines.length;i++){
    const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v=>v.replace(/^"|"$/g,'').trim());
    const obj = {};
    headers.forEach((h,j)=>obj[h]=values[j]||"");
    rows.push(obj);
  }
  return { headers, rows };
}

// Build table
function buildTable(headers, rows){
  const headerRow = document.getElementById("table-headers");
  headerRow.innerHTML = "";
  const colMapping = columnsToShow.map(c=>{
    return headers.find(h=>h.replace(/\s+/g,'').toLowerCase()===c.replace(/\s+/g,'').toLowerCase()) || null;
  });
  colMapping.forEach((h,i)=>{
    const th = document.createElement("th");
    th.textContent = columnsToShow[i];
    th.dataset.col = h;
    headerRow.appendChild(th);
  });

  const tbody = document.getElementById("table-body");
  tbody.innerHTML = "";
  rows.forEach(r=>{
    const tr = document.createElement("tr");
    colMapping.forEach(col=>{
      const td = document.createElement("td");
      let val = col && r[col]? r[col] : "";
      if(!isNaN(val) && val!=="") val = parseFloat(val).toFixed(2);
      td.textContent = val;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  return colMapping;
}

// Sorting
function makeSortable(colMapping){
  const headers = document.querySelectorAll("#table-headers th");
  headers.forEach((th,index)=>{
    th.addEventListener("click",()=>{
      const tbody = document.getElementById("table-body");
      const rows = Array.from(tbody.querySelectorAll("tr"));
      const isAsc = th.classList.contains("sorted-asc");
      rows.sort((a,b)=>{
        let aVal = parseFloat(a.children[index].textContent)||0;
        let bVal = parseFloat(b.children[index].textContent)||0;
        return isAsc? bVal-aVal : aVal-bVal;
      });
      rows.forEach(r=>tbody.appendChild(r));
      headers.forEach(h=>h.classList.remove("sorted-asc","sorted-desc"));
      th.classList.add(isAsc?"sorted-desc":"sorted-asc");
      highlightCells(colMapping);
    });
  });
}

// Highlight lowest 3 and highest distance
function highlightCells(colMapping){
  const tbody = document.getElementById("table-body");
  const rows = Array.from(tbody.querySelectorAll("tr"));

  timeCols.forEach(name=>{
    const colIndex = colMapping.findIndex(c=>c && c.replace(/\s+/g,'').toLowerCase()===name.replace(/\s+/g,'').toLowerCase());
    if(colIndex===-1) return;
    let values = rows.map(r=>parseFloat(r.children[colIndex].textContent)||Infinity);
    let sortedVals = Array.from(new Set(values)).sort((a,b)=>a-b); // unique sorted
    const ranks = [sortedVals[0], sortedVals[1], sortedVals[2]]; // top 3
    rows.forEach(r=>{
      r.children[colIndex].classList.remove("glow-gold","glow-silver","glow-bronze");
      const v = parseFloat(r.children[colIndex].textContent);
      if(v===ranks[0]) r.children[colIndex].classList.add("glow-gold");
      else if(v===ranks[1]) r.children[colIndex].classList.add("glow-silver");
      else if(v===ranks[2]) r.children[colIndex].classList.add("glow-bronze");
    });
  });

  const distIndex = colMapping.findIndex(c=>c && c.replace(/\s+/g,'').toLowerCase()===highlightDistanceCol.replace(/\s+/g,'').toLowerCase());
  if(distIndex!==-1){
    let values = rows.map(r=>parseFloat(r.children[distIndex].textContent)||-Infinity);
    let maxVal = Math.max(...values);
    rows.forEach(r=>{
      r.children[distIndex].classList.remove("glow-gold");
      if(parseFloat(r.children[distIndex].textContent)===maxVal) r.children[distIndex].classList.add("glow-gold");
    });
  }
}

// Initialize
async function init(){
  const csvText = await fetchSheetCSV();
  const { headers, rows } = parseCSV(csvText);
  const colMapping = buildTable(headers, rows);
  highlightCells(colMapping);
  makeSortable(colMapping);
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
